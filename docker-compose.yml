###############################################
# AI Employee Vault - Docker Compose
# Multi-service orchestration for cloud deploy
# Supports Bronze, Silver, Gold, and Platinum phases
###############################################

services:
  # ===========================================
  # Core Orchestrator Service (Bronze Phase)
  # ===========================================
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-employee-orchestrator
    restart: unless-stopped
    env_file:
      - .env
      - advanced.env
    environment:
      - VAULT_PATH=/app
      - DEV_MODE=false
      - HEALTH_PORT=8080
      - APP_VERSION=1.0.0
      - APP_PHASE=bronze
    ports:
      - "8080:8080"
    volumes:
      - vault-data:/app/Inbox
      - vault-data:/app/Needs_Action
      - vault-data:/app/Plans
      - vault-data:/app/Pending_Approval
      - vault-data:/app/Approved
      - vault-data:/app/In_Progress
      - vault-data:/app/Done
      - vault-data:/app/Logs
      - vault-data:/app/Briefings
      - vault-data:/app/Signals
    healthcheck:
      test: ["CMD", "python", "healthcheck.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - ai-employee-net
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    labels:
      - "ai.employee.phase=bronze"
      - "ai.employee.component=orchestrator"

  # ===========================================
  # Filesystem Watcher Service (Bronze Phase)
  # ===========================================
  filesystem-watcher:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-employee-fs-watcher
    restart: unless-stopped
    env_file:
      - .env
      - advanced.env
    environment:
      - VAULT_PATH=/app
      - APP_PHASE=bronze
    command: ["python", "watchers/filesystem_watcher.py"]
    volumes:
      - vault-data:/app/Drop_Folder
      - vault-data:/app/Inbox
    depends_on:
      orchestrator:
        condition: service_healthy
    networks:
      - ai-employee-net
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
    labels:
      - "ai.employee.phase=bronze"
      - "ai.employee.component=watcher"

  # ===========================================
  # Nginx Reverse Proxy
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: ai-employee-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx-certs:/etc/nginx/certs
    depends_on:
      orchestrator:
        condition: service_healthy
    networks:
      - ai-employee-net
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 64M
    labels:
      - "ai.employee.phase=all"
      - "ai.employee.component=proxy"

  # ===========================================
  # Log Aggregation (Lightweight)
  # ===========================================
  log-collector:
    image: grafana/promtail:latest
    container_name: ai-employee-logs
    restart: unless-stopped
    volumes:
      - vault-data:/app/Logs:ro
      - ./deploy/promtail/config.yml:/etc/promtail/config.yml:ro
    networks:
      - ai-employee-net
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 64M
    labels:
      - "ai.employee.phase=all"
      - "ai.employee.component=logging"

# ===========================================
# Volumes
# ===========================================
volumes:
  vault-data:
    driver: local
    labels:
      - "ai.employee.phase=all"
      - "ai.employee.purpose=data"
  nginx-certs:
    driver: local
    labels:
      - "ai.employee.phase=all"
      - "ai.employee.purpose=security"

# ===========================================
# Networks
# ===========================================
networks:
  ai-employee-net:
    driver: bridge
    labels:
      - "ai.employee.phase=all"
